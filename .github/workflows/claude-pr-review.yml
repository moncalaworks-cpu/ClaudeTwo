name: Claude PR Code Review

# DISABLED: To save costs on Anthropic API
# Uncomment below to enable PR code reviews
# on:
#   pull_request:
#     types: [opened, synchronize, reopened]
#     branches: [main]

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for context

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Get PR diff
          git fetch origin pull/$PR_NUMBER/head:pr-branch
          DIFF=$(git diff main..pr-branch)

          # Create review prompt
          PROMPT="Review this GitHub pull request for:
          1. Code quality and best practices
          2. Potential bugs or edge cases
          3. Security vulnerabilities
          4. Performance considerations
          5. Documentation completeness

          PR Title: ${{ github.event.pull_request.title }}
          PR Author: ${{ github.event.pull_request.user.login }}

          Diff:
          \`\`\`
          $DIFF
          \`\`\`

          Provide constructive feedback with specific line suggestions where applicable."

          # Run Claude review with safety limits
          claude --print "$PROMPT" \
            --model sonnet \
            --output-format json \
            --max-budget-usd 2 > review_output.json 2>&1 || true

      - name: Parse and post review
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reviewComment = '';

            try {
              const output = fs.readFileSync('review_output.json', 'utf8');
              const review = JSON.parse(output);
              reviewComment = review.content || review.text || 'Claude code review completed.';
            } catch (e) {
              reviewComment = 'Claude code review completed. Check workflow logs for details.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Claude Code Review\n\n${reviewComment}`
            });
