name: Review & Release to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - "VERSION"
      - ".github/workflows/review-and-release.yml"

permissions:
  contents: write
  pull-requests: write
  issues: write
  deployments: write

jobs:
  notify-review:
    name: Notify Review Required
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create review notification
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const body = "Document Review Required\n\n" +
              "Status: Review required before production release\n\n" +
              "Review Checklist:\n" +
              "- [ ] Documentation accurate\n" +
              "- [ ] Code comments clear\n" +
              "- [ ] No secrets exposed\n" +
              "- [ ] Examples tested\n" +
              "- [ ] Architecture documented\n" +
              "- [ ] Breaking changes noted\n\n" +
              "Next: Approve in GitHub Actions to release";

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['release-review'],
              per_page: 1
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Document Review Required - " + date,
                body: body,
                labels: ['release-review', 'waiting-approval']
              });
            }

  approval-gate:
    name: Await Human Review & Approval
    runs-on: ubuntu-latest
    needs: notify-review
    environment:
      name: Production Release
    steps:
      - name: Approval received
        run: echo "[APPROVED] Document review approved"

  production-release:
    name: Release to Production
    runs-on: ubuntu-latest
    needs: approval-gate
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "1.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Create release tag
        run: |
          git config user.name "Release Bot"
          git config user.email "release@example.com"
          TAG="v${{ steps.version.outputs.version }}"
          # Delete tag if it already exists locally and on remote
          git tag -d "$TAG" 2>/dev/null || true
          git push origin :refs/tags/"$TAG" 2>/dev/null || true
          # Create and push new tag
          git tag -a "$TAG" -m "Production release"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: "Production release v${{ steps.version.outputs.version }}"
          draft: false
          prerelease: false

      - name: Notify completion
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['release-review'],
              per_page: 1
            });

            if (issues.data.length > 0) {
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "Release Complete - v${{ steps.version.outputs.version }} deployed"
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                labels: ['release-review', 'completed']
              });
            }
