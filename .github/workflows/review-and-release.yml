name: Review & Release to Production

on:
  push:
    branches: [main]
    # Skip if only updating VERSION or this workflow file
    paths-ignore:
      - 'VERSION'
      - '.github/workflows/review-and-release.yml'

permissions:
  contents: write
  pull-requests: read
  deployments: write

jobs:
  notify-review:
    name: Notify Review Required
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create review notification
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit || context.sha;
            const author = context.payload.pusher?.name || context.actor;

            // Create or update issue for review
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['release-review'],
              per_page: 1
            });

            if (issues.data.length === 0) {
              const date = new Date().toISOString().split('T')[0];
              const shortCommit = commit.substring(0, 7);
              const body = "## Production Release Review\n\n" +
                "**Status:** Review required before production release\n\n" +
                "**Commit:** " + shortCommit + "\n" +
                "**Author:** " + author + "\n" +
                "**Date:** " + new Date().toISOString() + "\n\n" +
                "### Review Checklist\n" +
                "- [ ] Documentation is accurate and complete\n" +
                "- [ ] All code comments are clear\n" +
                "- [ ] No sensitive information exposed\n" +
                "- [ ] Examples are working and tested\n" +
                "- [ ] Architecture decisions are documented\n" +
                "- [ ] Breaking changes are noted\n\n" +
                "### Next Steps\n" +
                "1. Review the checklist items\n" +
                "2. Approve deployment in GitHub Actions\n" +
                "3. Production release will start automatically\n\n" +
                "---\n" +
                "*Automated review request - approval required to proceed*";

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Document Review Required - " + date,
                body: body,
                labels: ['release-review', 'waiting-approval']
              });
            }

      - name: Find and comment on related PRs
        uses: actions/github-script@v7
        with:
          script: |
            // Find recent PRs for this commit
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              per_page: 5
            });

            if (prs.data.length > 0) {
              for (const pr of prs.data) {
                const body = "## Ready for Review\n\n" +
                  "Push to main detected - awaiting human review and approval before production release.\n\n" +
                  "Check the Actions tab for Review & Release workflow status.";

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: body
                });
              }
            }

  # This job requires manual approval via GitHub Environment
  approval-gate:
    name: Await Human Review & Approval
    runs-on: ubuntu-latest
    needs: notify-review
    environment:
      name: Production Release
      # Add required reviewers in GitHub UI:
      # Settings â†’ Environments â†’ Production Release â†’ Required reviewers
    steps:
      - name: Approval received
        run: |
          echo "âœ… Document review approved by: ${{ github.actor }}"
          echo "Ready to proceed with production release"

  production-release:
    name: Release to Production
    runs-on: ubuntu-latest
    needs: approval-gate
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          # Extract version from package.json or VERSION file
          VERSION=$(cat VERSION 2>/dev/null || echo "1.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Create release tag
        run: |
          git config user.name "Release Bot"
          git config user.email "release@example.com"

          TAG="v${{ steps.version.outputs.version }}-${{ steps.version.outputs.timestamp }}"
          git tag -a "$TAG" -m "Production release - ${{ steps.version.outputs.timestamp }}"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Production Release

            **Version:** ${{ steps.version.outputs.version }}
            **Released:** ${{ steps.version.outputs.timestamp }}
            **Approved by:** ${{ github.actor }}

            ### Validation Summary
            âœ… All documentation validation passed
            âœ… Human review approved
            âœ… Ready for production deployment

            ### What's Included
            - All documentation updates
            - Code changes from recent commits
            - Configuration updates
          draft: false
          prerelease: false

      - name: Notify release completion
        uses: actions/github-script@v7
        with:
          script: |
            // Find and close the review issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['release-review'],
              per_page: 1
            });

            if (issues.data.length > 0) {
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ðŸš€ Release Complete

**Status:** Production release successful

**Version:** v${{ steps.version.outputs.version }}
**Released:** ${{ steps.version.outputs.timestamp }}
**Approved by:** @${{ github.actor }}

All changes have been deployed to production.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                labels: ['release-review', 'completed']
              });
            }

      - name: Send notification
        run: |
          echo "ðŸš€ Production release complete!"
          echo "Version: v${{ steps.version.outputs.version }}"
          echo "Released: ${{ steps.version.outputs.timestamp }}"
          echo "Approved by: ${{ github.actor }}"
